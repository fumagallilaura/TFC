

<details>
<summary><strong> Estrutura do projeto</strong></summary><br />

O projeto √© composto de 4 entidades importantes para sua estrutura:

1Ô∏è‚É£ **Banco de dados:**
  - Ser√° um container docker MySQL j√° configurado no docker-compose atrav√©s de um servi√ßo definido como `db`.
  - Tem o papel de fornecer dados para o servi√ßo de _backend_.
  - Durante a execu√ß√£o dos testes sempre vai ser acessado pelo `sequelize` e via porta `3002` do `localhost`;
  - Voc√™ tamb√©m pode conectar a um Cliente MySQL (Workbench, Beekeeper, DBeaver e etc), colocando as credenciais configuradas no docker-compose no servi√ßo `db`.

2Ô∏è‚É£ **Back-end:**
 - Ser√° o ambiente que voc√™ realizar√° a maior parte das implementa√ß√µes exigidas.
 - Deve rodar na porta `3001`, pois o front-end faz requisi√ß√µes para ele nessa porta por padr√£o;
 - Sua aplica√ß√£o deve ser inicializada a partir do arquivo `app/backend/src/server.ts`;
 - Garanta que o `express` √© executado e a aplica√ß√£o ouve a porta que vem das vari√°veis de ambiente;
 - Todas as depend√™ncias extras (tal como `joi`, `boom`, `express-async-errors`...) devem ser listadas em `app/backend/packages.npm`.

3Ô∏è‚É£ **Front-end:**
  - O front j√° est√° conclu√≠do, n√£o √© necess√°rio realizar modifica√ß√µes no mesmo. A √∫nica exce√ß√£o ser√° seu Dockerfile que precisar√° ser configurado.
  - Todos os testes a partir do requisito de login usam o `puppeteer` para simular uma pessoa acessando o site `http://localhost:3000/`;
  - O front se comunica com servi√ßo de back-end pela url `http://localhost:3001` atrav√©s dos endpoints que voc√™ deve construir nos requisitos.
  - Recomendamos que sempre que implementar um requisito no back-end acesse a p√°gina no front-end que consome a implementa√ß√£o para validar se est√° funcionando como esperado.

4Ô∏è‚É£ **Docker:**
  - O `docker-compose` tem a responsabilidade de unir todos os servi√ßos conteinerizados (backend, frontend e db) e subir o projeto completo com o comando `npm run compose:up` ou `npm run compose:up:dev`;
  - Voc√™ **deve** configurar as `Dockerfiles` corretamente nas ra√≠zes do `front-end` e `back-end`, para conseguir inicializar a aplica√ß√£o;

</details>


<details>
<summary><strong>üïµÔ∏è Linter</strong></summary><br />

Para garantir a qualidade do c√≥digo, usaremos o [ESLint](https://eslint.org/) para fazer a sua an√°lise est√°tica.

Para rodar o `ESLint` em um projeto, basta executar o comando `npm install` dentro do projeto e depois `npm run lint`. Se a an√°lise do `ESLint` encontrar problemas no seu c√≥digo, tais problemas ser√£o mostrados no seu terminal. Se n√£o houver problema no seu c√≥digo, nada ser√° impresso no seu terminal.

Voc√™ tamb√©m pode instalar o plugin do `ESLint` no `VSCode`: bastar ir em extensions e baixar o [plugin `ESLint`](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint).

</details>

<details>
<summary><strong> ‚ö†Ô∏è Configura√ß√µes m√≠nimas para execu√ß√£o do projeto</strong></summary><br />

Na sua m√°quina voc√™ deve ter:

 - Sistema Operacional Distribui√ß√£o Unix
 - Node vers√£o 16
 - Docker
 - Docker-compose vers√£o >=1.29.2

‚û°Ô∏è O `node` deve ter vers√£o igual ou superior √† `16.15.0 LTS`:
  - Para instalar o nvm, [acesse esse link](https://github.com/nvm-sh/nvm#installing-and-updating);
  - Rode os comandos abaixo para instalar a vers√£o correta de `node` e us√°-la:
    - `nvm install 16 --lts`
    - `nvm use 16`
    - `nvm alias default 16`

‚û°Ô∏è O`docker-compose` deve ter vers√£o igual ou superior √†`ÀÜ1.29.2`:
  * Use esse [link de refer√™ncia para realizar a instala√ß√£o corretamente no ubuntu](https://app.betrybe.com/course/back-end/docker/orquestrando-containers-com-docker-compose/6e8afaef-566a-47f2-9246-d3700db7a56a/conteudo/0006a231-1a10-48a2-ac82-9e03e205a231/instalacao/abe40727-6310-4ad8-bde6-fd1e919dadc0?use_case=side_bar);
  * Acesse o [link da documenta√ß√£o oficial com passos para desinstalar] (https://docs.docker.com/compose/install/#uninstallation) caso necess√°rio.

</details>

<details>
<summary><strong>üê≥ Configura√ß√£o Docker</strong></summary><br />

  ### Docker e Docker-compose

  ‚ö† O seu docker-compose precisa estar na vers√£o 1.29 ou superior.  ‚ö†
[Veja aqui a documenta√ß√£o para atualizar o docker-compose.](https://docs.docker.com/compose/install/)

‚ö†Ô∏è **Aten√ß√£o:**

- O arquivo `docker-compose.yml` pode ser utilizado para executar a aplica√ß√£o na sua m√°quina local, para isso √© necess√°rio executar o comando `npm run compose:up` na raiz do projeto.
- O comando `npm run compose:up:dev`, diferente do comando anterior, est√° configurado para compartilhar volumes com o _docker_ e tamb√©m utiliza o _script_ que realiza o _live-reload_ ao fazer modifica√ß√µes no _back-end_. Somente quando instalar uma nova dep√™ndencia ou alterar algum arquivo na raiz do backend, voc√™ dever√° realizar o re-build do seu compose, pois o volume est√° mapeando somente altera√ß√µes dentro da pasta `src` Voc√™ pode verificar essas configura√ß√µes explorando o arquivo `docker-compose.dev.yml` e comparar com `docker-compose.yml`

</details>

<details>
<summary><strong> ‚ö†Ô∏è Inicializa√ß√£o do compose e verifica√ß√£o dos logs das aplica√ß√µes </strong></summary><br />

- Considerando o uso do par√¢metro `healthcheck` em cada container do seu `docker-compose.yml`, a inicializa√ß√£o dos containers deve aguardar o comando de status de sa√∫de (o que valida se aquele container est√° operacional ou n√£o):
  - No container `db`, representado por um comando `ping` no banco de dados;
  - No back-end, representado por um comando `lsof`, que vai procurar aplica√ß√µes ativas na porta definida (por padr√£o, no caso `3001`);
  - No front-end, representado por um comando `lsof`, que vai procurar aplica√ß√µes ativas na porta definida (por padr√£o, no caso `3000`).

- Caso os containers respeitem as premissas anteriores, os mesmos devem ser criados sem maiores problemas:

![Cria√ß√£o dos containers conclu√≠da com sucesso!](assets/compose-status-01.png)

- Em caso de algum problema (no back-end, por exemplo), voc√™ deve se deparar com alguma mensagem do tipo:

![Erro no status de sa√∫de do container do back-end](assets/compose-status-03.png)

- A partir da pasta `./app` (onde est√° seu *docker-compose*), √© poss√≠vel rodar o comando `docker-compose logs` (Para ver todos os status) ou `docker-compose logs <nome-do-seu-servi√ßo>` (Para mostrar somente o de um escopo espec√≠fico).
  - ‚ö†Ô∏è √© indicado remover o par√¢metro `restart: 'always'` do seu servi√ßo, para que o mesmo n√£o polua seus logs;
  - No nosso contexto, rodando o comando `docker-compose logs backend`:

![docker-compose logs backend](assets/compose-status-04.png)

> Aqui n√£o houve problema com o `tsc`, por√©m a senha para acesso ao banco pelo sequelize estava errada.

 #### ‚ö†Ô∏è **Inicie o `docker-compose` antes de testar localmente!** ‚ö†Ô∏è

  Os testes v√£o utilizar a sua aplica√ß√£o do compose para fazer as valida√ß√µes, portanto **√© essencial que ela esteja funcionando corretamente** para que os testes passem!

  - Para isso, garanta que as aplica√ß√µes, tanto do back, quanto do front-end, possuem arquivos `Dockerfile` v√°lidos;
  - Utilize os scripts de apoio `npm run compose:up` / `npm run compose:down`, para facilitar a execu√ß√£o do seu *compose*.

</details>

<details id='Variaveis-de-ambiente'>
<summary><strong> ‚öôÔ∏è Vari√°veis de ambiente </strong></summary><br />

  **No diret√≥rio `app/backend/` renomeie o arquivo `.env.example` para `.env` e configure os valores de acordo com o cen√°rio do seu ambiente (credenciais de banco de dados, secrets desejadas e etc)**. Isso vai permitir que voc√™ inicialize a aplica√ß√£o fora do _container_ e ela se conecte com seu banco local caso deseje.
 > `./app/backend/.env.example`
  ```txt
  JWT_SECRET=jwt_secret
  APP_PORT=3001
  DB_USER=seu_user
  DB_PASS=sua_senha
  DB_HOST=localhost
  DB_PORT=3306
  ```

</details>


<details id='Criptografia-de-senhas'>
<summary><strong>üîê Criptografia de senhas </strong></summary><br />

‚ö†Ô∏è A biblioteca utilizada para criptografar a senha no banco de dados √© a `bcryptjs` [bcryptjs npm](https://www.npmjs.com/package/bcryptjs) e que j√° vem instalada no projeto e n√£o deve ser alterada ou substitu√≠da. Recomendamos que explore os recursos da biblioteca na documenta√ß√£o para implementar no projeto ao cadastrar um usu√°rio e ao realizar login ‚ö†Ô∏è

</details>

<details id='sequelize'>
  <summary><strong>üé≤ Sequelize</strong></summary>
  <br/>

  Para o desenvolvimento, o time de produto disponibilizou um *Diagrama de Entidade-Relacionamento (DER)* para construir a modelagem do banco de dados. Com essa imagem voc√™ j√° consegue saber:
  - Como nomear suas tabelas e colunas;
  - Quais s√£o os tipos de suas colunas;
  - Rela√ß√µes entre tabelas.

    ![Exemplo banco de dados](assets/er-diagram.png)

  ‚ö†Ô∏è O `package.json` do diret√≥rio `app/backend` cont√©m um script `db:reset` que √© respons√°vel por "dropar" o banco, recriar e executar as _migrations_ e _seeders_. Voc√™ pode execut√°-lo com o commando `npm run db:reset` se por algum motivo precisar recriar a base de dados;

  ‚ö†Ô∏è J√° existem _seeders_ prontas em `app/backend/src/database/seeders`. Assim que criar uma _migration_ voc√™ deve renomear a _seeder_ correspondente retirando o underline (`_`) ao fim dela, assim o script `db:reset` vai us√°-la nos testes e voc√™ se certificar√° se sua _migration_ funcionou como o esperado.

  ‚ö†Ô∏è Quaisquer execu√ß√£o referente ao sequelize-cli deve ser realizada dentro do diret√≥rio `app/backend`. Certifique-se de que antes de rodar comandos do sequelize j√° exista uma vers√£o compilada do back-end (diret√≥rio `app/build`), caso contr√°rio basta executar `npm run build` para compilar. O sequelize s√≥ funcionar√° corretamente se o projeto estiver compilado.

</details>

<details>
  <summary><strong>‚ÑπÔ∏è Status HTTP</strong></summary><br />

  Todas as "respostas" respeitam os [status do protocolo HTTP](https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status), com base no que o REST prega.

  Alguns exemplos:

  - Requisi√ß√µes que precisam de token mas n√£o o receberam devem retornar um c√≥digo de `status 401`;

  - Requisi√ß√µes que n√£o seguem o formato pedido pelo servidor devem retornar um c√≥digo de `status 400`;

  - Um problema inesperado no servidor deve retornar um c√≥digo de `status 500`;

  - Um acesso ao criar um recurso, no nosso caso usu√°rio ou partida, deve retornar um c√≥digo de `status 201`.

  - Quando solicitado algo que n√£o existe no banco, deve retornar um c√≥digo de `status 404`.

</details>

# Sobre o projeto

Esse projeto √© composto de 4 se√ß√µes principais:
1. Users e Login
2. Times
3. Partidas
4. Placar

## Database
  - Comece rodando o comando `npm run build` na pasta do `back-end` para fazer o _build_ da aplica√ß√£o;
  - [Nessa se√ß√£o](#sequelize) temos o diagrama de entidades;
  - Mantenha o arquivo `/app/backend/src/database/migrations/99999999999999-create-z.js`, pois ele √© necess√°rio para a avalia√ß√£o dos requisitos dessa se√ß√£o;
  - A leitura da se√ß√£o `B√¥nus: Model com Sequelize` no conte√∫do de `TypeScript: Tipagem Est√°tica e Generics`, contido [nesse link](https://app.betrybe.com/course/back-end/typescript/tipagem-estatica-e-generics/68eccf60-a982-4455-837d-da31e8726be5), √© recomend√°vel!

## Se√ß√£o 1: Users e Login

<details>
  <summary><strong> Introdu√ß√£o </strong></summary>

- A rota utilizada deve ser (`/login`);

- A rota deve receber os campos `email` e `password` e esses campos devem ser validados no banco de dados:
  - O campo `email` deve receber um email v√°lido;
  - O Campo `password` deve ter mais de 6 caracteres.

- O body da requisi√ß√£o deve conter o seguinte formato:
  ```json
  {
    "email": "string",
    "password": "string"
  }
  ```

</details>

<details>
  <summary><strong> Rotas </strong></summary>


### 1 - Endpoint `/login` no back-end.

  - Tipo `POST`;

- As senhas que existem no banco de dados est√£o encriptadas. Veja a [se√ß√£o de Criptografia de Senhas](#Criptografia-de-senhas) para mais detalhes de como comparar a senha do banco com a senha do corpo da requisi√ß√£o.

- Se o login foi feito com sucesso, o resultado retornado dever√° ser similar ao exibido abaixo, com um status http `200`:
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwicm9sZSI6ImFkbWluIiwiaWF0IjoxNjU0NTI3MTg5fQ.XS_9AA82iNoiVaASi0NtJpqOQ_gHSHhxrpIdigiT-fc" // Aqui deve ser o token gerado pelo backend.
  }
  ```

- Se o login n√£o tiver o campo "email", o resultado retornado dever√° ser a mensagem abaixo, com um status http `400`:
  ```json
    { "message": "All fields must be filled" }
  ```

  - Se o login n√£o tiver o campo "password", o resultado retornado dever√° ser conforme exibido abaixo, com um status http `400`:
  ```json
    { "message": "All fields must be filled" }
  ```

  - Se o login tiver o "email" **inv√°lido**, o resultado retornado ser√° similar ao exibido abaixo, com um status http `401`:
  ```json
    { "message": "Incorrect email or password" }
  ```

  - Se o login tiver a "senha" **inv√°lida**, o resultado retornado dever√° ser conforme exibido abaixo, com um status http `401`:
  ```json
    { "message": "Incorrect email or password" }
  ```

### 2 - Endpoint `/login/validate` no back-end.
  - Rota `GET` que recebe um `header` com par√¢metro `authorization`, onde ficar√° armazenado o token gerado no login;

  A resposta deve ser de status `200` com um `objeto` contendo a `role` do *user*:
  ```json
    { "role": "admin" }
  ```

</details>

## Se√ß√£o 2: Times

<details>
  <summary><strong> Introdu√ß√£o </strong></summary>

 - A seguir consideramos o consumo da rota `/teams` para retornar os nomes dos times associados √† partida na renderiza√ß√£o do front-end

</details>

<details>
  <summary><strong> Rotas </strong></summary>

### 3 - Endpoint `/teams` no back-end.

  - Rota `GET` com resposta com status `200` e com um `json` contendo o retorno no seguinte modelo:

```json
[
  {
    "id": 1,
    "teamName": "Ava√≠/Kindermann"
  },
  {
    "id": 2,
    "teamName": "Bahia"
  },
  {
    "id": 3,
    "teamName": "Botafogo"
  },
  ...
]
```

### 4 - Endpoint `/teams/:id` no back-end.

  - Deve ser uma rota `GET` com resposta com status `200` e com um `json` contendo o retorno no seguinte modelo:

```json
{
  "id": 5,
  "teamName": "Cruzeiro"
}
```

</details>

## Se√ß√£o 3: Partidas

<details>
  <summary><strong> Rotas </strong></summary>

### 5 - Endpoint `/matches` - tela de partidas no front-end.

  - Rota tipo `GET` e retorna uma lista de partidas;

  - A p√°gina apresentar√° todos os dados de partidas sem nenhum filtro.

    Exemplo de retorno:
    ```json
    [
      {
        "id": 1,
        "homeTeam": 16,
        "homeTeamGoals": 1,
        "awayTeam": 8,
        "awayTeamGoals": 1,
        "inProgress": false,
        "teamHome": {
          "teamName": "S√£o Paulo"
        },
        "teamAway": {
          "teamName": "Gr√™mio"
        }
      },
      ...
      {
        "id": 41,
        "homeTeam": 16,
        "homeTeamGoals": 2,
        "awayTeam": 9,
        "awayTeamGoals": 0,
        "inProgress": true,
        "teamHome": {
          "teamName": "S√£o Paulo"
        },
        "teamAway": {
          "teamName": "Internacional"
        }
      }
    ]
    ```

  - Ao escolher a op√ß√£o de partidas em andamento, ser√£o filtradas todas as partidas em andamento;

  - Essa requisi√ß√£o dever√° usar `query string` para definir o par√¢metro:
    ex: `matches?inProgress=true`

  Exemplo de retorno da requisi√ß√£o:
  ```json
  [
    {
      "id": 41,
      "homeTeam": 16,
      "homeTeamGoals": 2,
      "awayTeam": 9,
      "awayTeamGoals": 0,
      "inProgress": true,
      "teamHome": {
        "teamName": "S√£o Paulo"
      },
      "teamAway": {
        "teamName": "Internacional"
      }
    },
    {
      "id": 42,
      "homeTeam": 6,
      "homeTeamGoals": 1,
      "awayTeam": 1,
      "awayTeamGoals": 0,
      "inProgress": true,
      "teamHome": {
        "teamName": "Ferrovi√°ria"
      },
      "teamAway": {
        "teamName": "Ava√≠/Kindermann"
      }
    }
  ]
  ```

  - Ao escolher a op√ß√£o de partidas finalizadas, ser√£o filtradas todas as partidas finalizadas;

  - Essa requisi√ß√£o usa `query string` para definir o par√¢metro.
    ex: `matches?inProgress=false`

  Exemplo de retorno da requisi√ß√£o:
  ```json
  [
    {
      "id": 1,
      "homeTeam": 16,
      "homeTeamGoals": 1,
      "awayTeam": 8,
      "awayTeamGoals": 1,
      "inProgress": false,
      "teamHome": {
        "teamName": "S√£o Paulo"
      },
      "teamAway": {
        "teamName": "Gr√™mio"
      }
    },
    {
      "id": 2,
      "homeTeam": 9,
      "homeTeamGoals": 1,
      "awayTeam": 14,
      "awayTeamGoals": 1,
      "inProgress": false,
      "teamHome": {
        "teamName": "Internacional"
      },
      "teamAway": {
        "teamName": "Santos"
      }
    }
  ]
  ```

### 5 - Endpoint `/matches` √© poss√≠vel salvar uma partida com o status de inProgress como true no banco de dados

  - Rota do tipo `POST` e retorna a partida inserida no banco de dados;

  - A partida s√≥ pode ser criada com token JWT validado;

  - O corpo da requisi√ß√£o ter√° o seguinte formato:
  ```json
  {
    "homeTeam": 16, // O valor deve ser o id do time
    "awayTeam": 8, // O valor deve ser o id do time
    "homeTeamGoals": 2,
    "awayTeamGoals": 2
  }
  ```

  - Caso a partida seja inserida com sucesso, deve-se retornar os dados da partida, com _status_ `201`:

  ```json
  {
    "id": 1,
    "homeTeam": 16,
    "homeTeamGoals": 2,
    "awayTeam": 8,
    "awayTeamGoals": 2,
    "inProgress": true,
  }
  ```

### 6 - DEndpoint `/matches/:id/finish` - alterar o status inProgress de uma partida para false no banco de dados

  - Tipo `PATCH`;

  - Ser√° recebido o `id` pelo par√¢metro da URL;

  - Ser√° validado que, ao finalizar uma partida, a altera√ß√£o √© feita no banco de dados e na p√°gina.

  - Deve-se retornar, com um status `200`, a seguinte mensagem:

  ```json
  { "message": "Finished" }
  ```

### 28 - Endpoint `/matches/:id` - atualizar partidas em andamento

  - Tipo `PATCH`;

  - Ser√° recebido o `id` pelo par√¢metro da URL;

  - O corpo da requisi√ß√£o ter√° o seguinte formato:
  ```json
  {
    "homeTeamGoals": 3,
    "awayTeamGoals": 1
  }
  ```

</details>

> Obs: Projeto ainda em desenvolvimento. Ser√£o feitos mais testes e uma rota de leaderboard.
